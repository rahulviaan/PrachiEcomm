@using PrachiIndia.Portal.BAL;
@using PrachiIndia.Web.Areas.Model;
@using PrachiIndia.Portal.Models
@model objBook
@{
    #region CodeBehind
    ViewBag.Title = "Books Question";
    Layout = "~/Areas/CPanel/Views/Shared/_LayoutAdmin.cshtml";
    QuestionCategoryBAL blqc = new QuestionCategoryBAL();
    IEnumerable<SelectListItem> qcategory = (from m in blqc.GetAll(IsValid.Active) select m).AsEnumerable().Select(m => new SelectListItem() { Text = m.isTitle, Value = m.ID.ToString() });
    SelectList lstqcategory = new SelectList(qcategory, "Value", "Text");


    BookBal bl = new BookBal();
    IEnumerable<SelectListItem> books = (from m in bl.GetAllBooksHaveQuestion(IsValid.Active) select m).AsEnumerable().Select(m => new SelectListItem() { Text = m.title, Value = m.Id.ToString() });
    SelectList lst = new SelectList(books, "Value", "Text");


    //QuestionsBAL blq = new QuestionsBAL();
    //var lstQuestion = blq.BookQuestion(Model.Id, Model.isChapter, IsValid.Active, Model.book_id, Model.TopicID, Model.ChapterID);


    BookChapterBAL blc = new BookChapterBAL();
    var lstChpater = blc.GetAllByBook(Model.Id.ToString());

    QuestionCategoryBAL qcb = new QuestionCategoryBAL();
    var lstQC = qcb.GetAll(IsValid.All);
    var isBook = Model.title != null ? Model.title + " (" + ViewBag.QuestionCount + ")" : "";
    isBook = Model.isChapter != null ? isBook + "<small> Chapters: [ " + Model.isChapter + " ]</small>" : isBook;

    // var results = lstQuestion.GroupBy(p => p.idQuestionType,
    //(key, g) => new { idQuestionType = key, lstObj = g.ToList() });


    QuestionCategoryBAL QuestionCategoryBAL = new QuestionCategoryBAL();
    IEnumerable<SelectListItem> questioncategory = (from m in QuestionCategoryBAL.GetAll(IsValid.Active) select m).AsEnumerable().Select(m => new SelectListItem() { Text = m.isTitle, Value = m.ID.ToString() });
    SelectList lstquestioncategory = new SelectList(questioncategory, "Value", "Text");
    #endregion
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
@*<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>*@
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
<link href="~/Content/themes/flick/jquery-ui-1.8.4.custom.css" rel="stylesheet" />
<script src="~/Areas/CPanel/Containt/Dashboard/js/jquery-ui-1.10.4.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<link href="~/Content/Dashboard/css/toastr.min.css" rel="stylesheet" />
@Html.AntiForgeryToken()
@Html.ValidationSummary(true)

<div class="col-md-12">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 id="idTotal" class="card-title">Books Question</h4>
        </div>
        <div class="panel-body">
            <div class="box-icon">

                <a href="#" class="btn btn-minimize btn-round"><i class="icon-chevron-up"></i></a>
                <a class="btn btn-round" title="Print Data" onclick="window.print()" href="#">
                    <i class="icon-color icon-print"></i>
                </a>
            </div>
            <input type="hidden" id="hdIdQuestion" value="" />
            <table class="table">

                <tr>

                    <td style="border:none;padding:0;">
                        @using (Html.BeginForm())
                        {
                            @Html.Hidden("Qid", 0)
                            <div class="dvSearchPrint">
                                <div id="dvSearchQuestion">
                                    <table class="table table-bordered">
                                        <tr>
                                            <td colspan="2">
                                                <table class="table">
                                                    <tr>
                                                        <td width="25%" style="border:none;">
                                                            <label>Select Book</label>
                                                            @Html.DropDownListFor(m => m.Id, lst, "--Select Book--", new { @class = "form-control" })
                                                        </td>
                                                        <td id="BookChapter" width="25%" style="border:none;">
                                                            <label>Select Chapter</label>
                                                            @Html.DropDownListFor(x => x.ChapterID, new List<SelectListItem>(), "--Select--", new { @class = "form-control" })
                                                        </td>
                                                        <td id="BookTopic" width="25%" style="border:none;">
                                                            <label>Select Topic</label>
                                                            @Html.DropDownListFor(x => x.TopicID, new List<SelectListItem>(), "--Select--", new { @class = "form-control" })
                                                        </td>
                                                        <td width="25%" style="border:none;">
                                                            <label>Select Question Category</label>
                                                            @Html.DropDownListFor(m => m.book_id, lstqcategory, "--Select Category--", new { @class = "form-control" })
                                                        </td>
                                                    </tr>
                                                </table>


                                            </td>

                                        </tr>
                                        <tr>
                                            <td>
                                                <div id="dvChapters" class="btn-group btn-group-sm col-md-9" aria-label="Small button group" role="group">
                                                    @Html.HiddenFor(m => m.isChapter)
                                                    <label class="btn btn-default" for="chkCh1">
                                                        <input class="jsChaper" type="checkbox" id="chkCh1" name="chkCh1" value="0-5" />
                                                        CH: 1-5
                                                    </label>
                                                    <label class="btn btn-default" for="chkCh2">
                                                        <input class="jsChaper" type="checkbox" id="chkCh2" name="chkCh2" value="6-10" />
                                                        CH: 6-10
                                                    </label>
                                                    <label class="btn btn-default" for="chkCh3">
                                                        <input class="jsChaper" type="checkbox" id="chkCh3" name="chkCh3" value="11-15" />
                                                        CH: 11-15
                                                    </label>
                                                    <label class="btn btn-default" for="chkCh4">
                                                        <input class="jsChaper" type="checkbox" id="chkCh4" name="chkCh4" value="16-20" />
                                                        CH:16-20
                                                    </label>
                                                    <label class="btn btn-default" for="chkCh5">
                                                        <input class="jsChaper" type="checkbox" id="chkCh5" name="chkCh5" value="21-25" />
                                                        CH: 21-25
                                                    </label>
                                                    <label class="btn btn-default" for="chkCh6">
                                                        <input class="jsChaper" type="checkbox" id="chkCh6" name="chkCh6" value="26-30" />
                                                        CH: 26-30
                                                    </label>
                                                    <label class="btn btn-default" for="chkCh7">
                                                        <input class="jsChaper" type="checkbox" id="chkCh7" name="chkCh7" value="31-2000" />
                                                        CH: >30
                                                    </label>

                                                </div>
                                            </td>
                                            <td>
                                                <button id="btnSearchQuestion" type="button" class="btn btn-primary">View Question</button>
                                            </td>
                                        </tr>
                                    </table>



                                </div>
                                <div style="display: none" id="dvUpdateQuestion">
                                    <input type="hidden" id="idQuestion" value="" />
                                    Select Type @Html.DropDownList("idQuestionCategory", lstquestioncategory, "--Select Question Type--")
                                    <button id="btnUpdate" type="button">Update Selected Questions</button>
                                </div>
                            </div>
                        }
                    </td>

                </tr>

                <tr>
                    <td style="border:none;padding:0">
                        <div id="idPrint">
                            <table class="table table-bordered">

                                <thead id="thead">
                                    <tr>
                                        <td>
                                            <h4 class="card-title">@Html.Raw(isBook)   </h4>
                                            <div style="text-align:center;display:none" id="loaderDiv">
                                                <img src="~/Content/tinymce/skins/lightgray/img/Loader1.gif" />
                                            </div>
                                        </td>
                                        <td width="10%" align="right">
                                            <button style="display: none" type="button" id="btnDelete" class="btn btn-danger">Delete Selected Question </button>

                                        </td>
                                    </tr>

                                </thead>
                                <tbody id="tbody"></tbody>
                            </table>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog" style="left:0;">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"><strong>Question ID : </strong><strong id="modelHeader">QuestionID</strong></h4>
                </div>
                <div class="modal-body panel-body">
                    <div class="col-md-12 form-group">
                        <label>Select Question Category</label>

                        @Html.DropDownList("catID", lstqcategory, "--Select Category--", new { @class = "form-control" })
                    </div>
                    <div class="col-md-12 form-group" id="BookChapter-1">
                        <label>Select Chapter</label>

                        @Html.DropDownList("chpID", new List<SelectListItem>(), "--Select--", new { @class = "form-control" })<SelectListItem><SelectListItem><SelectListItem><SelectListItem><SelectListItem>
                    </div>
                    <div class="col-md-12 form-group" id="BookTopic-1">
                        <label>Select Topic</label>
                        @Html.DropDownList("topicID", new List<SelectListItem>(), "--Select--", new { @class = "form-control" })<SelectListItem><SelectListItem><SelectListItem><SelectListItem><SelectListItem>
                    </div>
                    <div class="col-md-12 form-group" id="BookTopic-1">
                        <label>Select Type</label>
                        @Html.DropDownList("typeID", new List<SelectListItem>(), "--Select--", new { @class = "form-control" })<SelectListItem><SelectListItem><SelectListItem><SelectListItem><SelectListItem>
                    </div>
                    <div class="col-md-12 form-group text-center">
                        <button type="button" class="btn btn-primary" id="Updatebtn" onclick="UpdateQuestion()">Update</button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                    </div>

                    <div style="text-align:center;display:none" id="loaderDiv">
                        <img src="~/Content/tinymce/skins/lightgray/img/Loader1.gif" />
                    </div>
                </div>

            </div>

        </div>
    </div>
</div>

<style>
    .toast-top-right {
        right: 40% !important;
        top: 20% !important;
        opacity: 1 !important;
    }
</style>

<link href="~/Content/themes/flick/jquery-ui-1.8.4.custom.css" rel="stylesheet" />

<link href="~/Content/themes/flick/base.css" rel="stylesheet" />

<script src="~/Scripts/print.js"></script>

<script type="text/javascript">


    function Print() {
        var idPrint = document.getElementById("idPrint");
        var Head = document.getElementsByTagName("head");
        CallPrint($(Head).html(), $("#idPrint").html());

    }
    $(function () {
        @*var Bookid = @Html.Raw(Json.Encode(Model.Id));
        var ChapterID = @Html.Raw(Json.Encode(Model.ChapterID));
        var TopicID = @Html.Raw(Json.Encode(Model.TopicID));
        GetTopic(ChapterId);
        GetChapter(Bookid);*@

        //$("#ChapterID").val(ChapterId);
        //$("#TopicID").val(TopicID);
        var Bookid = @Html.Raw(Json.Encode(Model.Id));
        $("#Qid").val(Bookid)
        $('#Id').change(function () {
            var Bookid = $(this).val();
            $.ajax({
                type: "post",
                url: "/Books/GetChapters",
                data: { BookID: Bookid },
                datatype: "json",
                traditional: true,
                success: function (data) {

                    var ddlChapter= $("#ChapterID");
                    ddlChapter.empty();
                    ddlChapter.append('<option value=0>--Select Chapter--</option>');
                    for (var i = 0; i < data.length; i++) {
                        ddlChapter.append('<option value=' + data[i].Value + '>' + data[i].Text + '</option>');
                    }

                }
            });
        });

        $('#ChapterID').change(function () {
            var ChapterId = $(this).val();
            $.ajax({
                type: "post",
                url: "/Books/GetTopic",
                data: { ChapterID: ChapterId },
                datatype: "json",
                traditional: true,
                success: function (data) {
                    //var district = "<select id='TopicID'>";
                    //district = district + '<option value="">--Select--</option>';
                    var ddlTopic = $("#TopicID");
                    ddlTopic.empty();
                    ddlTopic.append('<option value=0>--Select Topic--</option>');
                    for (var i = 0; i < data.length; i++) {
                        //district = district + '<option value=' + data[i].Value + '>' + data[i].Text + '</option>';
                        ddlTopic.append('<option value=' + data[i].Value + '>' + data[i].Text + '</option>');
                    }
                }
            });
        });


        $("#isChapter").val("");
        var collection = $(".jsQuestion:checked");
        collection.each(function () {
            this.checked = false;

        });
        $(document).on("click", "#btnSearchQuestion", function () {
            $("#isChapter").val("");
            var isChapter = "";
            var chapters = $(".jsChaper:checked");
            var i = 0;
            chapters.each(function () {
                isChapter += this.value + ","
                i = i + 1;
            });

            if (isChapter != "")
                isChapter = isChapter.substr(0, isChapter.length - 1);
            $("#isChapter").val(isChapter);

            var model = @Html.Raw(Json.Encode(Model.Id));
            var Chapterid = $("#ChapterID").val();
            var Id = $("#Id").val();
            var TopicID = $("#TopicID").val();
            var isChapter = $("#isChapter").val();
            var questionType = $("#book_id").val();

            if (questionType == "") {
                questionType = 0;
            }
            if(TopicID == "") {
                TopicID = 0;
            }
            if (Chapterid == "") {
                Chapterid = 0;
            }
            var url = "/TestHour/Books/GetOptedQuestionTest?Id=" + Id + "&ischapetr=" + isChapter + "&bookid=" + questionType + "&TopicId=" + TopicID + "&Chaperid=" + Chapterid;
            //alert(url);
            $("#loaderDiv").show();
            $.ajax({
                type: "Get",
                url: url,
                success: function (response) {
                    $("#loaderDiv").hide();
                    $("#tbody").html(response);
                    $("#loader").hide();
                }
            });
        });

        $(document).on("click", ".jsQuestion", function () {

            var _tbl = $(this).attr("_tbl");
            if (this.checked == true) {
                $("#" + _tbl + "").css({ "background-color": "#97d1fa" });
            }
            else {
                $("#" + _tbl + "").css({ "background-color": "#fff" });
            }

            var idQuestion = "";
            var collection = $(".jsQuestion:checked");
            var i = 0;
            $("#idQuestion").val("");
            collection.each(function () {
                idQuestion += this.value + ","
                i = i + 1;
            });

            if (idQuestion != "")
                idQuestion = idQuestion.substr(0, idQuestion.length - 1);
            $("#btnUpdate").html("Update Selected #" + i + " Questions");
            $("#btnDelete").html("Delete Selected #" + i + " Questions");

            $("#idQuestion").val(idQuestion);
            if (idQuestion != "") {
                $("#dvSearchQuestion").hide();
                $("#dvUpdateQuestion").show();
                $("#btnDelete").show();

            }
            else {
                $("#dvSearchQuestion").show();
                $("#dvUpdateQuestion").hide();
                $("#btnDelete").hide();

            }


        });
        $(document).on("click", "#btnUpdate", function () {
            var idQuestion = $("#idQuestion").val();
            var idQuestionCategory = $("#idQuestionCategory").val();
            idQuestion = $.trim(idQuestion);
            if (idQuestion != "") {
                if ($.trim(idQuestionCategory) != "") {
                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("BatchUpdateQuestion", "Books")',
                        data: { idQuestion: idQuestion, idQuestionCategory: idQuestionCategory },
                        dataType: "json",
                        success: function (data) {
                            if (data == null || data.data == "0") {
                                var opt = $.parseJSON('{"text":" Error occur try again.","layout":"center","type":"error"}')
                                noty(opt);
                            }
                            else {
                                var collection = $(".jsQuestion:checked");
                                collection.each(function () {
                                    this.checked = false;
                                    var _tbl = $(this).attr("_tbl");
                                    $("#" + _tbl + "").css({ "background-color": "#fff" });
                                });
                                //var opt = $.parseJSON('{"text":" Updated Selected Questions Successfully ","layout":"center","type":"information"}')
                                //noty(opt);
                                toastr.error("Updated Selected Questions Successfully", '', { timeOut: 5000 })
                                $("#dvSearchQuestion").show();
                                $("#dvUpdateQuestion").hide();
                                $("#btnDelete").hide();
                            }
                        }
                    });
                }
                else {
                    alert("Please select question category need to update.");
                    $("#idQuestionCategory").focus();
                }

            }
            else {
                var collection = $(".jsQuestion:checked");
                collection.each(function () {
                    this.checked = false;
                    var _tbl = $(this).attr("_tbl");
                    $("#" + _tbl + "").css({ "background-color": "#fff" });
                });
                alert("Please select question need to update.");
            }
        });
        $(document).on("click", "#btnDelete", function () {
            var idQuestion = $("#idQuestion").val();
            idQuestion = $.trim(idQuestion);

            if (window.confirm("Are you sure want to delete selected questions?")) {

                if (idQuestion != "") {
                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("BatchUpdateStatusQuestion", "Books")',
                        data: { idQuestion: idQuestion },
                        dataType: "json",
                        success: function (data) {
                            var array = idQuestion.split(",");
                            $.each(array, function (i) {
                                $("#tbl_" + array[i]).remove();
                            });
                            if (data == null || data.data == "0") {
                                var opt = $.parseJSON('{"text":" Error occur try again.","layout":"center","type":"error"}')
                                noty(opt);
                            }
                            else {
                                var collection = $(".jsQuestion:checked");
                                collection.each(function () {
                                    this.checked = false;
                                    var _tbl = $(this).attr("_tbl");
                                    $("#" + _tbl + "").css({ "background-color": "#fff" });
                                });
                                toastr.error("Selected Questions Deleted Successfull", '', { timeOut: 5000 })
                                $("#dvSearchQuestion").show();
                                $("#dvUpdateQuestion").hide();
                                $("#btnDelete").hide();
                            }
                        }
                    });
                }
                else {
                    var collection = $(".jsQuestion:checked");
                    collection.each(function () {
                        this.checked = false;
                        var _tbl = $(this).attr("_tbl");
                        $("#" + _tbl + "").css({ "background-color": "#fff" });
                    });
                    alert("Please select question need to update.");
                }
            }
        });
    });


    function openPopUp(quid)
    {
        var book_id = @Html.Raw(Json.Encode(Model.book_id));
        var ChapterID = @Html.Raw(Json.Encode(Model.ChapterID));
        $(".modal-content #modelHeader").text(quid)
        fillDropdown();
        GetTopic(ChapterID)
        $("#catID").val(book_id);
        $('#myModal').modal('show');
    }
    function fillDropdown()
    {
        //Filling Dropdown value......
        var Bookid = @Html.Raw(Json.Encode(Model.Id));

        GetChapter(Bookid)
        $.ajax({
            type: "post",
            url: "/Books/GetQuestionType",
            datatype: "json",
            traditional: true,
            success: function (data) {
                var ddltype= $("#typeID");
                ddltype.empty();
                ddltype.append('<option value=0>--Select Type--</option>');
                for (var i = 0; i < data.length; i++) {
                    ddltype.append('<option value=' + data[i].Value + '>' + data[i].Text + '</option>');
                }
            }
        });
    }


    $('#chpID').change(function () {
        var ChapterId = $(this).val();
        GetTopic(ChapterId);

    });

    function GetChapter(Bookid)
    {
        var ChapterID = @Html.Raw(Json.Encode(Model.ChapterID));
        $.ajax({
            type: "post",
            url: "/Books/GetChapters",
            data: { BookID: Bookid },
            datatype: "json",
            traditional: true,
            success: function (data) {
                var ddlChapt= $("#chpID");
                ddlChapt.empty();
                ddlChapt.append('<option value=0>--Select Chapter--</option>');
                for (var i = 0; i < data.length; i++) {
                    if(data[i].Value==ChapterID){
                        ddlChapt.append('<option value=' + data[i].Value + '  selected="true">' + data[i].Text + '</option>');
                    }
                    else {
                        ddlChapt.append('<option value=' + data[i].Value + '>' + data[i].Text + '</option>');
                    }
                }
            }
        });
    }
    function GetTopic(ChapterId)
    {
        var TopicID = @Html.Raw(Json.Encode(Model.TopicID));
        $.ajax({
            type: "post",
            url: "/Books/GetTopic",
            data: { ChapterID: ChapterId },
            datatype: "json",
            traditional: true,
            success: function (data) {
                var ddlTopics = $("#topicID");
                ddlTopics.empty();
                ddlTopics.append('<option value=0>--Select Topic--</option>');
                for (var i = 0; i < data.length; i++) {
                    if(data[i].Value==TopicID){
                        ddlTopics.append('<option value=' + data[i].Value + ' selected="true">' + data[i].Text + '</option>');
                    }
                    else {
                        ddlTopics.append('<option value=' + data[i].Value + '>' + data[i].Text + '</option>');
                    }
                }
            }
        });
    }
    function UpdateQuestion(){

        var validation=true;
        var CategoryID=$("#catID").val();
        var ChapterID=$("#chpID").val();
        var TopicID=$("#topicID").val();
        var quid= $("#Qid").val()
        var TypeID= $("#typeID").val()
        if(CategoryID=="")
        {
            toastr.error("Category is requried", '', { timeOut: 5000 })
            validation=false;
            return false;
        }
        if(ChapterID==0)
        {
            toastr.error("Chapter is requried", '', { timeOut: 5000 })
            validation=false;
            return false;
        }
        if(TopicID==0)
        {
            toastr.error("Topic is requried", '', { timeOut: 5000 })
            validation=false;
            return false;
        }
        if(TypeID==0)
        {
            toastr.error("Type is requried", '', { timeOut: 5000 })
            validation=false;
            return false;
        }
        if(validation)
        {
            $("#loaderDiv").show();

            $("#Updatebtn").hide();

            $.ajax({
                type: "post",
                url: "/Books/UpdateQuestions",
                data: { QID:quid,CategoryID: CategoryID,ChapterID: ChapterID,TopicID: TopicID,TypeID:TypeID},
                datatype: "json",
                traditional: true,
                success: function (data) {
                    $("#loaderDiv").hide();
                    $("#Updatebtn").show();
                    $("#myModal").modal("hide");
                }

            });
        }


       }
</script>



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="~/Scripts/bootstrap.min.js"></script>



