@using PrachiIndia.Portal.BAL;
@using PrachiIndia.Web.Areas.Model;
@using System.Linq;

@model PrachiIndia.Portal.Models.objBook
@{
    ViewBag.Title = "Manage Books";
    Layout = "~/Areas/CPanel/Views/Shared/_LayoutAdmin.cshtml";
    SeriesBal bl = new SeriesBal();
    IEnumerable<SelectListItem> series = (from m in bl.GetAllSeriesSubject(IsValid.Active) select m).AsEnumerable().Select(m => new SelectListItem() { Text = m.title, Value = m.Id.ToString() });
    SelectList lst = new SelectList(series, "Value", "Text", ViewBag.SeriesId);
}
@Html.AntiForgeryToken()
@Html.ValidationSummary(true)
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
@*<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>*@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
<link href="~/Content/themes/flick/jquery-ui-1.8.4.custom.css" rel="stylesheet" />
<script src="~/Areas/CPanel/Containt/Dashboard/js/jquery-ui-1.10.4.min.js"></script>
<div class="col-md-12">
    <div class="panel panel-default">
        <div class="panel-heading"><h4 class="card-title" id="idTotal">  Manage Books<a class="pull-right" href="#" _id="0" onclick="AddForm()"><i class="fa fa-plus" aria-hidden="true"></i></a></h4></div>
        <div class="panel-body">
            <div class="col-md-6 form-group">
                Select Series  @Html.DropDownList("ddnSeries", lst, "--All Books--", new { @class = "form-control" })
            </div>
            <table class="tablepagination table table-bordered" id="tdStates">

                <thead id="thead" class="bg-info" style="display: none">
                    <tr>
                        <th width="15%">
                            Image
                        </th>
                        <th width="50%">Title</th>

                        <th width="15%">ISBN</th>


                        <th width="15%">Action To Be Performed</th>

                    </tr>

                </thead>
                <tbody id="tbody">
                    <tr>
                        <td colspan="3">
                            <div class="ndata">No Data found................</div>
                        </td>
                    </tr>

                </tbody>
            </table>
        </div>
    </div>
</div>
<div style="display: none;" id="dialog-form" title="">
    <img src="/img/ajax-loaders/ajax-loader-5.gif" />

</div>


<link href="~/Content/themes/flick/base.css" rel="stylesheet" />
@*<script src="http://localhost:14764/Scripts/jquery-1.10.2.min.js"></script>
    @Scripts.Render("~/bundles/jquery")*@
    @Scripts.Render("~/bundles/jqueryval")
    <script type="text/javascript">
        function UploadImage(dv) {

            var _id = $(dv).attr('_id');
            var _img = $(dv).attr('_img');
            var _title = $(dv).attr('_title');
            var sid = $("#ddnSeries option:selected").attr("value");
            $("#dialog-form").html(' <img src="/img/ajax-loaders/ajax-loader-5.gif" />');
            $("#dialog-form").dialog({
                title: "Upload '" + _title + "' Image",
                autoOpen: false,
                position: ['center', 'top'],
                height: 550,
                width: 500,
                show: { effect: 'drop', direction: "up" },
                draggable: false,
                resizable: false,
                show: { effect: 'drop', direction: "up" },
                modal: true,
                buttons: {
                    Cancel: function () {
                        $(this).dialog("close");
                    },
                    Submit: function () {
                        $('form#frmMain').submit();
                    }
                },


                open: function (event, ui) {


                    $("#dialog-form").html("  <form autocomplete='off' id='frmMain'  method='post'  novalidate='novalidate' enctype='multipart/form-data'>    <table width='100%'> <tr> <td><input type='hidden' id='hdID' name='hdID' value='" + _id + "' />    <input type='hidden' id='hdSeries' name='hdSeries' value='" + sid + "' /> Upload New Image: <input type='file' height='100' name='upImg' id='upImg' /> <input type='submit' value='submit'/>  </td></tr> <tr>  <td>   <img width='300'  onerror='SetDefault(this)'  src='/Library/images/" + _img + ".jpg' title='' alt=''/> </td>    </tr>  </table>  <table></form>");
                }, close: function (event, ui) {

                }
            });
            $("#dialog-form").dialog("open");
            return false;
        }
        function AddForm() {

            $("#dialog-form").html('<img src="/img/ajax-loaders/ajax-loader-5.gif" />');
            var url = '@Url.Action("SelectPartialView", "Books", new { id = "_Books" })';
            $("#dialog-form").dialog({
                title: "Add Books",
                autoOpen: false,
                resizable: false,
                position: ['center', 'top'],
                height: 650,
                width: 900,
                show: { effect: 'drop', direction: "up" },
                draggable: false,
                resizable: false,
                modal: true,
                buttons: {

                },
                open: function (event, ui) {
                    $(this).load(url);
                }, close: function (event, ui) {
                    FillGrid("0");
                }
            });
            $("#dialog-form").dialog("open");

        }
        function SetDefault(th) {

            //  th.src = "/Images/book.png";
            th.height = 50;
            th.width = 50;
        }


        function FillGrid(hs) {
            var tbl = "";

            var sid = $("#ddnSeries option:selected").attr("value");
            var url = window.location.hash.substr(1);
            $("#tbody").html('<img src="/img/ajax-loaders/ajax-loader-5.gif" />');


            if ($.trim(url) != "" && parseInt($.trim(url)) > 0 && hs != "0") {
                sid = parseInt($.trim(url));
                $("#ddnSeries").val($.trim(url));
            }
            sid = sid == "" ? "-1" : sid;
            $.ajax({
                type: "POST",
                url: '@Url.Action("getBooksJson", "Books",new {Area="TestHour" })',
                data: { series_id: sid },
                success: function (data) {
                    tbl = "";

                    $("#idTotal").html("Manage Books [" + data.length + "]")
                    $.each(data, function () {

                        var _url = '@Url.Action("UpdateBooks", "Admin")';

                        var act = "";
                        var tact = "";

                        if (this.is_active == '1') {
                            act = "Inactive";


                            tact = "<span  class='icon icon-color icon-check'></span>";


                        }
                        else {
                            act = "Active";

                            tact = "<span  class='icon icon-color icon-close'></span>";

                        }

                        tbl += "<tr  > <td _id='" + this.Id + "' align='center' class='jsover'>  ";
                        tbl += "<a isTitle='" + this.title + "' _id='" + this.Id + "' href='javascript:void(0);'     class='openpopup'> <img width='50px'   onerror='SetDefault(this)' src='/ModuleFiles/Items/" + this.image_path +"'  title='" + this.title + "' />";
                        if (this.audio == "1") {
                            tbl += "  <span style='position:absolute; 'title='This is audio book' class='icon32 icon-color icon-volume-on'  ></span>"
                        }

                        tbl += " </a>";
                        //tbl += " <div   onclick='UploadImage(this )'    _title='" + this.title + "' _img='" + this.image_path + "' _Series_id='" + this.su + "'  _id='" + this.Id + "' id='edimg_" + this.Id + "' class='editimage'>      Edit Image   </div>";
                        tbl += "</td>";
                        tbl += " <td>  <a isTitle='" + this.title + "' _id='" + this.Id + "' href='javascript:void(0);'     class='openpopup'>" + this.title + "(" + this.sizeondisk + ")</a> </td>"
                        tbl += "<td align='center'> " + this.isbn + "</td> ";
                        tbl += "<td align='center'>";
                        //tbl += "<li >  <a title='Edit' class='jsedit btn'  href='javascript:void(0);' id='ed_" + this.Id + "'  _id='" + this.Id + "' isTitle='" + this.title + " '><i class='fa fa-pencil' aria-hidden='true'></i> </a></li>";
                        //tbl += " <li style='width:50px;'><a  _url='" + _url + "' class='jsActiveInactive  btn'  _isValid='" + act + "'  _id='" + this.Id + "' id='ac_" + this.Id + "'   href='javascript:void(0);'>" + tact + "</a> </li>";
                        tbl += "<a href='@Url.Action("ManageChapters", "Books")?id=" + this.Id + "' title='Add Book Chapters' class='jsaddtopic  btn'  href='javascript:void(0);' id='ed_" + this.Id + "'  _id='" + this.Id + "' isTitle='" + this.title + " '><i class='fa fa-plus' aria-hidden='true'></i> </a>";
                        tbl += "</td>";
                    });
                    if (tbl == "") {
                        $("#thead").fadeOut('fast');
                        $("#tbody").html(" <tr><td colspan='2'><div class='ndata'>No Data found................</div></td></tr>");

                    }
                    else {
                        $("#thead").fadeIn('fast');
                        $("#tbody").html(tbl);
                        $('.tablepagination').tablePagination({});
                    }

                }
            })
        }


        function AddClass(_brd, _cls) {
            var tbl = "";
            var ulclass = $("#ulclass");
            var ulboard = $("#ulboard");

            $("#ulboard").html('');
            $("#ulclass").html('');
            $.ajax({
                type: "POST",
                url: '@Url.Action("getClassJson", "Admin")',
                success: function (data) {
                    tbl = "";
                    $.each(data, function () {

                        tbl += "<li><input type='checkbox' value='" + this.Id + "' id='chkc_" + this.Id + "'/><label for='chkc_" + this.Id + "'>" + this.title + "</label></li>"


                    });
                    if (tbl == "") {

                        $("#ulclass").html('');
                    }
                    else {

                        $("#ulclass").html(tbl);
                        if (_brd != "") {
                            var tmp = _brd.split(',');
                            for (i = 0; i < tmp.length; i++) {
                                document.getElementById('chkc_' + tmp[i] + '').checked = true;
                            }
                        }
                    }
                }
            })

            $.ajax({
                type: "POST",
                url: '@Url.Action("getBoardJson", "Admin")',
                success: function (data) {
                    tbl = "";
                    $.each(data, function () {
                        tbl += "<li><input type='checkbox' value='" + this.Id + "' id='chkb_" + this.Id + "'/><label for='chkb_" + this.Id + "'>" + this.title + "</label></li>"
                    });
                    if (tbl == "") {

                        $("#ulboard").html('');
                    }
                    else {

                        $("#ulboard").html(tbl);
                        if (_cls != "") {

                            var tmp = _cls.split(',');
                            var i = 0;
                            for (i = 0; i < tmp.length; i++) {
                                document.getElementById('chkb_' + tmp[i] + '').checked = true;
                            }
                        }
                    }

                }
            })

        }

        function SetSeries() {
            $.ajax({
                type: "POST",
                url: '@Url.Action("getSeriesJson", "Admin")',
                data: { subjectId: $("#subject_id > option:selected").attr("value") },
                success: function (data) {
                    var items = [];
                    items.push("<option value=''>--Choose Series--</option>");

                    $.each(data, function () {
                        items.push("<option value=" + this.Id + ">" + this.title + "</option>");
                    });

                    $("#series_id").html(items.join(' '));
                }
            })



        }

        function UpdateSize(al) {
            $(al).attr("disabled", true);
            $(al).html('<img src="/Content/img/ajax-loaders/ajax-loader-5.gif" />')
            $.ajax({
                type: "POST",
                url: '@Url.Action("UpdateBookSizeOnDisk", "Admin")',
                success: function (data) {
                    if (data.data == "-1") {
                        var opt = $.parseJSON('{"text":" Error ocuur try again.","layout":"top","type":"error"}');
                        noty(opt);
                    }
                    else {
                        var opt = $.parseJSON('{"text":" Updated Books -' + data.data + ' successfully ","layout":"center","type":"information"}')
                        noty(opt);
                    }
                    $(al).attr("disabled", false);
                    $(al).html('Update Book Size On Disk')
                }
            })
        }

        function CheckCheckBox(chkboard) {

            var brd = "";


            for (var i = 0; i < chkboard.length; i++) {
                if (chkboard[i].checked) {
                    brd += chkboard[i].value + ",";
                }
            }

            return brd == "" ? "0" : brd.substring(0, brd.length - 1);
        }
        $(function () {
            var select = $('#ddnSeries');
            var opt1 = null;
            var opt2;
            var opttxt = '';
            var opttxt1 = '';
            var optg = '';
            var i = 1;
            $('option', select).each(function (i) {
                var lbl = $(this).text();
                i = parseInt(i) + 1;

                if (lbl.indexOf('(') > -1) {
                    opttxt = lbl.substring(lbl.lastIndexOf('('));

                }


                if (opttxt1 == '' && opttxt != '') {
                    opttxt1 = opttxt;

                    if (optg.indexOf('</optgroup><optgroup label="' + opttxt + '">') == -1) {
                        optg += '</optgroup><optgroup label="' + opttxt + '">';
                        i = i + 1;
                    }

                }



                if (opttxt != opttxt1) {
                    opttxt1 = '';
                    if (optg.indexOf('</optgroup><optgroup label="' + opttxt + '">') == -1) {
                        optg += '</optgroup><optgroup label="' + opttxt + '">';
                    }
                    optg += ' <option  value=' + $(this).val() + '>' + $(this).text().replace(opttxt, '') + '</option>';

                }
                else {
                    if ($(this).val() == '') {
                        optg += ' <option value="" >' + $(this).text() + '</option>';
                        optg = optg.replace("</optgroup>", "");
                    }
                    else {
                        optg += ' <option value=' + $(this).val() + '>' + $(this).text().replace(opttxt, '') + '</option>';

                    }
                }



            });

            optg = optg + ' </optgroup>';

            $("#ddnSeries").html(optg);
            $("#ddnSeries").val('@ViewBag.SeriesId');
            FillGrid();

            $(document).on("change", "#ddnSeries", function () {
                FillGrid("0");
            });

            $(document).on("click", ".openpopup", function () {
                var isTitle = $(this).attr("isTitle");
                var url = '@Url.Action("SelectPartialView", "Admin", new { id = "_viewBooks" })';
                var edid = "?edid=" + $(this).attr("_id")
                url += edid;
                $("#dialog-form").html(' <img src="/Content/img/ajax-loaders/ajax-loader-5.gif" />');
                $("#dialog-form").dialog({
                    title: isTitle,
                    autoOpen: false,
                    position: ['center', 'top'],
                    height: 650,
                    width: 900,

                    show: { effect: 'drop', direction: "up" },
                    draggable: false,
                    resizable: true,
                    show: { effect: 'drop', direction: "up" },
                    modal: true,
                    buttons: {
                        Cancel: function () {
                            $(this).dialog("close");
                        }
                        //Submit: function () {

                        //}
                    },


                    open: function (event, ui) {
                        $(this).load(url);

                    }, close: function (event, ui) {

                    }
                });
                $("#dialog-form").dialog("open");

                return false;
            });

            $(document).on("click", ".jsedit", function () {
                // SetInitial();
                $("#dialog-form").html(' <img src="/Content/img/ajax-loaders/ajax-loader-5.gif" />');
                var url = '@Url.Action("SelectPartialView", "Admin", new { id = "_editBooks" })';
                var edid = "?edid=" + $(this).attr("_id")
                url += edid;
                $("#dialog-form").dialog({

                    title: "Edit Book",
                    autoOpen: false,
                    resizable: false,
                    position: ['center', 'top'],
                    height: 650,
                    width: 900,
                    show: { effect: 'drop', direction: "up" },
                    draggable: false,
                    resizable: false,
                    modal: true,
                    buttons: {
                        //Cancel: function () {
                        //    $(this).dialog("close");
                        //}
                        //Submit: function () {

                        //}
                    },


                    open: function (event, ui) {
                        $(this).load(url);
                    }, close: function (event, ui) {
                        FillGrid("0");
                    }
                });
                $("#dialog-form").dialog("open");
                return false;


            });

            $(document).on("click", "#btnCancel", function () {
                $("#dialog-form").dialog("close");

            });
            $(document).on("mouseover", ".jsover", function () {

                var dv = this;//.parentNode.parentNode;
                var div = dv.getElementsByTagName("div");
                // $(div[0]).css("display", "block") Avnish Kumar Singh open if want to edit book image
                $(div[0]).css("display", "none")

            });
            $(document).on("mouseout", ".jsover", function () {

                var dv = this;//.parentNode.parentNode;
                var div = dv.getElementsByTagName("div");
                $(div[0]).css("display", "none")


            });


            $(document).on("click", ".jsActiveInactive", function () {
                var ii = window.confirm("Are you sure edit this status.")
                if (!ii)
                { return false; }



                var uid = $(this).attr('_id');
                var uaction = $(this).attr('_isValid');
                var _url = $.trim($(this).attr('_url'));

                var v1 = this;

                ///////////////////////
                $.ajax({
                    type: 'POST',
                    url: _url,
                    data: { id: uid, action: uaction },
                    dataType: "json",
                    success: function (data) {

                        if (data.data == "0") {


                            alert("Server error try later.")
                            // $(this).attr('_isValid', data.data);
                        }
                        else {
                            var tact = "";
                            if (data.data == 'Active') {

                                tact = "<span  class='icon icon-color icon-close'></span>";
                            }
                            else {
                                tact = "<span  class='icon icon-color icon-check'></span>";

                            }
                            $(v1).html(tact);
                            $(v1).attr('_isValid', data.data);


                        }
                    }
                });

                ////////////////////
            });


            $(document).on("submit", "#sup_form", function (e) {

                $("#sup_form").unbind('#sup_form').submit(
                    function () {

                    }
                );

                if ($(this).valid()) {
                    e.preventDefault();

                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("IsExistBooks", "Admin")',
                        data: { title: $("#title").val(), Id: $("#Id").val(), series_id: $("#series_id > option:selected").attr("value"), subject_id: $("#subject_id > option:selected").attr("value") },
                        success: function (data) {
                            if (data.data == "0") {

                            }
                            else {
                                $("#title").val('');
                                alert("This Book name already exist try  another.");
                                $("#title").focus();
                                return false;
                            }

                        }
                    })

                    var brd_id = "0";
                    var cls_id = "0";
                    var _ebook = "";
                    var sup_ment = "";
                    var prnt = "";
                    var muti = "";
                    var _audio = "";

                    var ulboard = document.getElementById("ulboard");
                    var chkboard = ulboard.getElementsByTagName("input");
                    brd_id = CheckCheckBox(chkboard);


                    var ulclass = document.getElementById("ulclass");
                    var clsboard = ulclass.getElementsByTagName("input");
                    cls_id = CheckCheckBox(clsboard);

                    _audio = document.getElementById("chkAudio").checked == true ? '1' : '0';
                    _ebook = document.getElementById("chkeBook").checked == true ? '1' : '0';
                    sup_ment = document.getElementById("chkSuppleymentary").checked == true ? '1' : '0';
                    prnt = document.getElementById("chkPrint").checked == true ? '1' : '0';
                    muti = document.getElementById("chkMultimedia").checked == true ? '1' : '0';

                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("AddBooks", "Admin")',
                        data: { title: $("#title").val(), Id: $("#Id").val(), subject_id: $("#subject_id > option:selected").attr("value"), series_id: $("#series_id > option:selected").attr("value"), price: $("#price").val(), no_of_pages: $("#no_of_pages").val(), author: $("#author").val(), isbn: $("#isbn").val(), edition: $("#edition").val(), description: $("#description").val(), board_id: brd_id, class_id: cls_id, ebook: _ebook, suppleymentary: sup_ment, _print: prnt, multimedia: muti, audio: _audio },
                        success: function (data) {
                            if (data.data == "1") {
                                $("#tblInsert").fadeOut('fast');
                                var v1 = $("#title").val() + " inserted successfully .<a href='#' onclick='Addmore()'> Add More </a>"
                                $("#dvMessage").html(v1);
                            }
                            else if (data.data == "2") {
                                $("#tblInsert").fadeOut('fast');
                                var v1 = "<h4>" + $("#title").val() + "</h4>  updated successfully "
                                $("#dvMessage").html(v1);
                            }
                            else {
                                alert("Error Occur Try Later.");
                            }

                        }
                    })

                }

            });

        });

        $(document).on("change", "#subject_id", function () {
            SetSeries();
        });

        $(document).on("change", "#title", function () {
            $.ajax({
                type: "POST",
                url: '@Url.Action("IsExistBooks", "Admin")',
                data: { title: $("#title").val(), Id: $("#Id").val(), series_id: $("#series_id > option:selected").attr("value"), subject_id: $("#subject_id > option:selected").attr("value") },
                success: function (data) {
                    if (data.data == "0") {

                    }
                    else {
                        $("#title").val('');
                        alert("This Book name already exist try  another.");
                        $("#title").focus();
                    }

                }
            })

        });
    </script>


